function JsCollection(elements,options){options=Object.assign({url:'',minToRequest:1,justUse:0,},options);var that={attach:function(elements){Iterable(elements).forEach(function(input){if(input.getAttribute('data-multiple')){JsCollectionSelectorMultiple(input,options);}else{JsCollectionSelector(input,options);}});return true;},};options.fireEvent=function(eventName,context){if(typeof this[eventName]=='function'){return this[eventName].apply(context,arguments);}};that.attach(elements);return that;}
function JsCollectionSelector(input,options){var name=input.name;var wrapper=input.parentNode.parentNode;var xmark=wrapper.querySelector('button');var hidden=wrapper.querySelector('input[type=hidden]');var picker=JsCollectionPicker(wrapper,input,options,function(value,caption,justUse){input.value=caption;input.name=justUse?name:'';hidden.value=value;active(false);});function clear(){hidden.value='';input.name='';}
function active(status){if(status){if(input.readOnly){clear();input.value='';input.readOnly=false;input.parentNode.removeChild(xmark);input.focus();}}else{input.readOnly=true;input.parentNode.appendChild(xmark);}}
if(hidden.value){active(false);}else{input.parentNode.removeChild(xmark);}
input.name='';input.addEventListener('click',function(){active(true);});input.addEventListener('input',function(){clear();if(input.value.length<options.minToRequest){return picker.hide();}
JsCollectionEngine(input,picker,options);});input.addEventListener('reset',function(){active(true);});xmark.addEventListener('click',function(){active(true);});}
function JsCollectionSelectorMultiple(input,options){let value=JSON.parse(input.getAttribute('data-options'));let __name=input.name;let name=input.name.slice(2);input.name='';let wrapper=input.parentNode.parentNode;let group=wrapper.querySelector('ul');let picker=JsCollectionPicker(wrapper,input,options,function(value,caption,justUse){let tagName=justUse?__name:name;if(justUse){value=caption;}
let html='<div class="input-tag">'+caption
+'<input type="hidden" name="'+tagName+'[]" value="'+value+'"/>'
+'</div>'
+'<a href="javascript:void(0)" class="input-tag" role="button" aria-labelledby="collection-delete-option"><i class="fa-solid fa-xmark"></i></a>';let tag=group.appendChild(JsElement('li.input-tag-group',{html:html}));tag.setAttribute('role','option');tag.querySelector('a').addEventListener('click',function(){tag.parentNode.removeChild(tag);options.fireEvent('onDelete',picker);});input.value='';});for(let i in value){picker.create(i,value[i]);}
input.addEventListener('input',function(){if(input.value.length<options.minToRequest){return picker.hide();}
JsCollectionEngine(input,picker,options);});}
function JsCollectionPicker(wrapper,input,options,select){let status;let selected=-1;let picker=wrapper.querySelector('div[role=listbox]');let body=document.querySelector('body');input.addEventListener('keydown',function(event){if(event.key=='Enter'){event.preventDefault();if(selected>-1){picker.querySelectorAll('ul li')[selected].click();}else{input.click();}}else if(event.key=='ArrowDown'){event.preventDefault();nav(true);}else if(event.key=='ArrowUp'){event.preventDefault();nav(false);}else{selected=-1;}});function nav(forward){if(status){let li=picker.querySelectorAll('ul li');let total=li.length;selected+=forward?1:-1;if(selected<0){selected=0;}else if(selected>(total-1)){selected=(total-1);}
li.forEach(function(el,i){el.classList.toggle('active',i==selected);});}}
function toggle(i){status=Boolean(i);body[['removeEventListener','addEventListener'][i]]('click',picker.hide);picker.style.display=['none',''][i];input.setAttribute('aria-expanded',status);}
return JsElement(picker,{events:{click:function(event){event.stopPropagation();}},show:function(){toggle(1);},hide:function(){toggle(0);},select:function(value,caption,justUse){if(options.fireEvent('onSelect',this,value,caption)===false){return;}
select(value,caption,justUse);this.hide();options.fireEvent('onSuccess',this);},create:select,});}
var JsCollectionEngine=(function(){var input,picker,options;var Libraries=[];var Tables=[];var RQ={'[áàâä]':'a','[éèêë]':'e','[íìîï]':'i','[óòôö]':'o','[úùûü]':'u','[ñ]':'n'};var QR={'a':'[aáàâä]','e':'[eéèêë]','i':'[iíìîï]','o':'[oóòôö]','u':'[uúùûü]','n':'[nñ]'};function _findL(q){let i=q.length+1;while(i--){if(Libraries[i]){let j=Libraries[i].length;while(j--){if(Libraries[i][j].q==q){return Libraries[i][j];}}}
q=q.substr(0,i-1);}
return false;}
function getRegExp(re){for(let i in QR){re=re.replace(RegExp(i,'gi'),QR[i]);}
return RegExp(re,'i');}
function _findQ(Library,q){let rows=[];let length=Library.rows.length;if(length){let re=getRegExp(q);for(let j=0;j<length;j++){i=Library.rows[j];if(Tables[Library.iT].rows[i][1].search(re)!=-1){rows.push(i);}}}
return _saveL(q,Library.iT,rows);}
function _callback(q,json){json.isAll=json.isTable||json.isAll;let iT=Tables.push({rows:json.rows,isAll:json.isAll,})-1;let rows=[];for(let i in json.rows){rows[i]=i;}
if(json.isTable){_printL(_findQ(_saveL('',iT,rows),q));}else{_printL(_saveL(q,iT,rows));}}
function _saveL(q,iT,rows){let i=q.length;if(!Libraries[i]){Libraries[i]=[];}
let j=Libraries[i].push({q:q,iT:iT,rows:rows,})-1;return Libraries[i][j];}
function _printL(Library){let rows=[];let length=Library.rows.length;for(let i=0;i<length;i++){rows[i]=Tables[Library.iT].rows[Library.rows[i]];}
render(rows,Library.q);}
function renderLine(ul,value,dt,dd,ju){let html='<div class="dt">'+dt+'</div>';if(dd){html+='<div class="dd">'+dd+'</div>';}
let li=ul.appendChild(JsElement('li',{html:html}));if(ju){li.classList.add('just-use');li.setAttribute('aria-labelledby','collection-just-use')}
li.setAttribute('role','option');li.setAttribute('aria-label',dt);li.addEventListener('click',function(){picker.select(value,dt,ju);});}
function render(rows,q){let ju=options.justUse&&input.value;let ul=JsElement('UL');rows.forEach(function(row){renderLine(ul,row[0],row[1],row[2],false);if(ju&&row[1].toLowerCase()==q){ju=false;}});if(ju){let value=input.value.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');renderLine(ul,-1,value,'',true);}
if(ul.firstChild){picker.innerHTML='';picker.appendChild(ul);picker.show();}else{picker.hide();}}
function normalize(q){q=q.toLowerCase();for(i in RQ){q=q.replace(RegExp(i,'g'),RQ[i]);}
return q;}
return function(i,p,o){input=i;picker=p;options=o;var q=normalize(input.value);var Library=_findL(q);if(Library){if(Library.q==q){return _printL(Library);}else if(Tables[Library.iT].isAll){return _printL(_findQ(Library,q));}}
JsRequest.json({url:options.url,data:JsRequest.mergeData(options.data,{q:q}),onSuccess:function(json){_callback(q,json);},});};})();var cropImage=function(src,callback,options,LastPosition){let image=new Image();image.src=src;image.onload=function(){let isProportional;const limits={};const minWH=40;const wrapper=JsElement('div.crop-image',{html:'<div><div><div></div><div></div><div></div><div></div></div></div><button class="btn btn-primary btn-solid btn-block">OK</button>'});const lightbox=Lightbox({hideWithOverlay:false}).setContent(wrapper);const container=wrapper.querySelector('div');const frame=container.querySelector('div');const handle=frame.querySelectorAll('div');const enter=wrapper.querySelector('button');function set(values){for(let i in values){limits[i]=values[i];}}
function between(v,min,max){return v<min?min:(v>max?max:v);}
function resize(styles){for(let i in styles){frame.style[i]=styles[i]===null?'initial':styles[i]+'px';}}
function resizeStartFn(i){return function(event){event.stopPropagation();event.preventDefault();let position={top:null,right:null,bottom:null,left:null};let a=container.getBoundingClientRect();let b=frame.getBoundingClientRect();switch(i){case 0:case 3:set({iniX:event.clientX+b.width,maxW:b.x-a.x+b.width,signX:-1});position.right=a.x+a.width-b.x-b.width;break;case 1:case 2:set({iniX:event.clientX-b.width,maxW:a.x+a.width-b.x,signX:1});position.left=b.x-a.x;break;}
switch(i){case 0:case 1:set({iniY:event.clientY+b.height,maxH:b.y+b.height-a.y,signY:-1});position.bottom=a.y+a.height-b.y-b.height;break;case 2:case 3:set({iniY:event.clientY-b.height,maxH:a.y+a.height-b.y,signY:1});position.top=b.y-a.y;break;}
resize(position);if(!isProportional){isProportional=event.shiftKey==1;}};}
function resizeMoveFn(event){let styles={width:between(limits.signX*(event.clientX-limits.iniX),minWH,limits.maxW)};if(isProportional){styles.height=styles.width*options.proportion;if(styles.height>limits.maxH){styles.height=limits.maxH;styles.width=limits.maxH/options.proportion;}}else{styles.height=between(limits.signY*(event.clientY-limits.iniY),minWH,limits.maxH);}
resize(styles);}
container.insertBefore(image,container.firstChild);for(let i=0;i<4;i++){JsMove(handle[i],resizeStartFn(i),resizeMoveFn);}
JsMove(frame,function(event){event.stopPropagation();event.preventDefault();let a=container.getBoundingClientRect();let b=frame.getBoundingClientRect();set({iniX:event.clientX-b.x+a.x,iniY:event.clientY-b.y+a.y,maxX:a.width-b.width,maxY:a.height-b.height});},function(event){resize({left:between(event.clientX-limits.iniX,0,limits.maxX),top:between(event.clientY-limits.iniY,0,limits.maxY)});});options=Object.assign({proportion:null},options);if(typeof LastPosition!='function'){LastPosition=function(position){return position||{};};}
var position=LastPosition();if(!Object.keys(position).length){var a=container.getBoundingClientRect();var proportion=a.height/a.width;position={top:0,left:0,width:a.width,height:a.height};if(options.proportion){isProportional=true;if(proportion>options.proportion){position.height=position.width*options.proportion;position.top=(a.height-position.height)/2;}else{position.width=position.height/options.proportion;position.left=(a.width-position.width)/2;}}else{options.proportion=proportion;}}
resize(position);enter.addEventListener('click',function(){let a=container.getBoundingClientRect();let b=frame.getBoundingClientRect();let correctorX=image.naturalWidth/a.width;let correctorY=image.naturalHeight/a.height;let left=b.x-a.x;let top=b.y-a.y;let x=left*correctorX;let y=top*correctorY;let width=b.width*correctorX;let height=b.height*correctorY;let canvas=JsElement('canvas');let ctx=canvas.getContext('2d');let mime=image.src.split(':')[1].split(';')[0];canvas.width=width;canvas.height=height;ctx.drawImage(image,x,y,width,height,0,0,width,height);callback(canvas.toDataURL(mime));LastPosition({top:top,left:left,width:b.width,height:b.height});lightbox.remove();});};};var FeDate=(function(){var Picker=(function(){var Locale=null;return function(fn,withTime){var date;var selected;var firstDayOfWeek=1;var _panels={};var icons=['fa-solid fa-chevron-left','fa-solid fa-circle','fa-solid fa-chevron-right','fa-solid fa-chevron-up','fa-solid fa-chevron-down','fa-regular fa-clock',];function setSelected(){selected=new Date(date.getTime());}
function select(){setSelected();fn(date);return this;}
function builder(selector,cols,rows=1){var thead='';var tbody='';if(typeof rows=='object'){for(var i=0,L=rows.length;i<L;i++){thead+='<th>'+rows[i]+'</th>';}
rows=L;thead='<thead><tr>'+thead+'</tr></thead>';}
for(var i=0,L=rows*cols;i<L;i++){tbody+=(!(i%cols)&&i?'</tr><tr>':'')+'<td></td>';}
picker.querySelector(selector).innerHTML='<table>'
+thead
+'<tbody><tr>'+tbody+'</tr></tbody>'
+'</table>';var grids=Array.from(picker.querySelectorAll(selector+' table tbody tr td'));var that={click:function(fn){grids.forEach(function(el,i){el.addEventListener('click',function(){fn(el,i);});});return that;},icon:function(v){grids.forEach(function(el,i){if(v[i]){el.innerHTML='<i class="'+icons[v[i]-1]+'"></i>';}});return that;},html:function(fn){grids.forEach(function(el,i){el.innerHTML=fn(i);});return that;},set:function(methods){for(var i in methods){_panels[i]=methods[i].bind({grids:grids});}
return that;},};return that;}
function toggle(opt){if(opt&&picker.classList.contains('x'+opt)){opt=0;}
switch(opt){case 0:_panels.updateDays();break;case 1:_panels.updateMonths();break;case 2:_panels.updateYears();break;case 3:_panels.updateHours();_panels.updateMinutes();break;}
picker.className='fe-date x'+opt;}
if(!Locale){Locale={months:[],shortMonths:[],shortWeekdays:[]};var auxDate=new Date();for(var i=0;i<12;i++){auxDate.setMonth(i);Locale.months[i]=auxDate.toLocaleString(undefined,{month:'long'});Locale.shortMonths[i]=auxDate.toLocaleString(undefined,{month:'short'});}
for(var i=0;i<7;i++){Locale.shortWeekdays[i]=new Date(2017,9,i+1).toLocaleString(undefined,{weekday:'short'});}}
var picker=JsElement('div.fe-date',{html:'<div class="header"></div>'
+'<div class="s-days"><div class="days"></div><div class="nav"></div></div>'
+'<div class="s-months"></div>'
+'<div class="s-years"><div class="years"></div><div class="nav"></div></div>'
+(withTime?'<div class="s-time"></div><div class="s-hours"></div><div class="s-minutes"></div>':'')});picker.setStyles=function(styles){for(var i in styles){this.style[i]=styles[i];}};picker.load=function(v){date=v||new Date();setSelected();toggle(0);};builder('.header',withTime?3:2).click(function(el,i){toggle(i+1);}).set({updateHeader:function(year,month=-1){this.grids[1].innerHTML=year;if(month>-1){this.grids[0].innerHTML=Locale.months[month];}}}).icon([0,0,6]);builder('.s-days .nav',3).click(function(el,i){_panels.updateDays(i-3);}).icon([1,2,3]);var rows=[];for(var i=0;i<7;i++){rows.push(Locale.shortWeekdays[(firstDayOfWeek+i)%7]);}
builder('.days',7,rows).click(function(el){var month;var day=el.innerHTML;if(el.className=='ext'){month=day<15?-1:-3;}
_panels.updateDays(month,day);select();_panels.updateDays();}).set({updateDays:function(monthCmd,dayCmd){if(monthCmd!=undefined){switch(monthCmd){case-2:var curDate=new Date();date.setFullYear(curDate.getFullYear(),curDate.getMonth(),curDate.getDate());break;case-3:case-1:monthCmd+=2+date.getMonth();default:date.setMonth(monthCmd);break;}}
if(dayCmd!=undefined){date.setDate(dayCmd);}
var month=date.getMonth();var year=date.getFullYear();var firstDay=(7-firstDayOfWeek+(new Date(year,month,1).getDay()))%7;var lastDay=new Date(year,month+1,0).getDate();var prevDays=new Date(year,month,0).getDate()-firstDay;var day=nextDays=0;var fn=function(el,i,css){el.innerHTML=i;el.className=css;};for(var i=0;i<42;i++){if(i>=firstDay&&day<lastDay){fn(this.grids[i],++day,'');}else{fn(this.grids[i],day?++nextDays:++prevDays,'ext');}}
var curDate=new Date();if(curDate.getFullYear()==year&&curDate.getMonth()==month){this.grids[curDate.getDate()+firstDay-1].classList.add('today');}
if(selected&&selected.getFullYear()==year&&selected.getMonth()==month){this.grids[selected.getDate()+firstDay-1].classList.add('selected');}
_panels.updateHeader(year,month)}});builder('.s-months',4,3).click(function(el,i){_panels.updateDays(i);toggle(0);}).html(function(i){return Locale.shortMonths[i];}).set({updateMonths:function(){var i=12;var month=date.getMonth();while(i--){this.grids[i].className=(i==month?'selected':'');}}});builder('.s-years .nav',2).click(function(el,i){_panels.updateYears(i?1:-1);}).icon([1,3]);builder('.years',3,5).click(function(el){date.setFullYear(el.innerHTML);_panels.updateDays();toggle(1);}).set({updateYears:function(page){var i=15;var year=date.getFullYear();if(page){year+=(page*i);date.setFullYear(year);}
while(i--){this.grids[i].innerHTML=year+i-7;this.grids[i].className=(i==7?'selected':'');};_panels.updateHeader(year);}});if(withTime){builder('.s-time',2,3).click(function(el,i){switch(i){case 0:_panels.updateHours(1);break;case 1:_panels.updateMinutes(1);break;case 2:toggle(4);break;case 3:toggle(5);break;case 4:_panels.updateHours(-1);break;case 5:_panels.updateMinutes(-1);break;}}).icon([4,4,0,0,5,5]).set({updateHours:function(v){if(v){v+=date.getHours();date.setHours(v>23?0:(v<0?23:v));}
this.grids[2].innerHTML=pad(date.getHours());select();},updateMinutes:function(v){if(v){v+=date.getMinutes();date.setMinutes(v>59?0:(v<0?59:v));}
this.grids[3].innerHTML=pad(date.getMinutes());select();}});builder('.s-hours',4,6).click(function(el,i){date.setHours(i);toggle(3);_panels.updateHours();}).html(function(i){return pad(i);});builder('.s-minutes',3,4).click(function(el,i){date.setMinutes(i*5);toggle(3);_panels.updateMinutes();}).html(function(i){return pad(i*5);});}
return picker;};})();function pad(number){if(number<10){return'0'+number;}
return number;}
function newDate(textDate){var match=textDate.match(/^\d{4}-\d{2}-\d{2}(T\d{2}:\d{2}(:\d{2})?)?$/);if(!match){return;}else if(match[1]==undefined){textDate+='T00:00:00';}else if(match[2]==undefined){textDate+=':00';}
return new Date(textDate);};return function(elements,options){var _picker,_curElement;var that={attach:function(elements){elements=Iterable(elements);var i=elements.length;while(i--)(function(el){var name=el.name;el.name='';el.setAttribute('readonly',true);var H=el.parentNode.insertBefore(JsElement('INPUT',{'type':'hidden','name':name}),el);el.getHDate=function(){return H.value?newDate(H.value):false;};el.setHDate=function(v){this.value=v.toLocaleDateString()
+(options.type?' '+v.toLocaleTimeString().replace(/^(\d{1,2}:\d{1,2}):\d{1,2}([^\d]*)$/,'$1$2'):'');H.value=v.getFullYear()
+'-'+pad(v.getMonth()+1)
+'-'+pad(v.getDate())
+(options.type?'T'+pad(v.getHours())+':'+pad(v.getUTCMinutes()):'');};if(el.value){var ct=newDate(el.value);if(ct){el.setHDate(ct);}else{el.value='';}}
if(options.setDrop){el.addEventListener('focus',function(){that.show(el);});}})(elements[i]);},show:function(el){_curElement=el;this.displayTime=Date.now();if(options.setPosition&&_curElement){var rect=_curElement.getBoundingClientRect();_picker.setStyles({position:'absolute',top:(rect.top+rect.height+3)+'px',left:rect.left+'px','z-index':1000});}
_picker.load(_curElement?_curElement.getHDate():false);_picker.setStyles({display:'block'});this.fireEvent('onShow');return this;},hide:function(){_picker.setStyles({display:'none',position:'',top:'',left:'',});this.fireEvent('onHide');_curElement=null;return this;},fireEvent:function(name,param){if(typeof options[name]=='function'){this[name]=options[name];this[name](param);}},};options=Object.assign({inject:null,setPosition:1,setDrop:1,offset:{x:5,y:-3},type:0,onSelect:function(date){_curElement&&_curElement.setHDate(date);},},options);options.type=options.type=='datetime-local'?1:0;if(typeof options.inject=='string'){options.inject=document.querySelector(options.inject);}
that.attach(elements);_picker=new Picker(options.onSelect.bind(that),options.type);if(options.setDrop){document.querySelector('html').addEventListener('click',function(){if(_picker.style.display=='block'&&Date.now()-that.displayTime>200){that.hide();}});_picker.setStyles({display:'none'});_picker.addEventListener('click',function(event){event.stopPropagation();return false;});}else{_picker.load();}
(options.inject||document.body).appendChild(_picker);return that;};})();JsFelem.implement({'date':function(el){FeDate(el);},'datetime-local':function(el){FeDate(el,{'type':'datetime-local'});}});JsFelem.observe({'input[type=date]':function(el){if(el.type!='date'){FeDate(el,{'type':'date'});}},'input[type=datetime-local]':function(el){if(el.type!='datetime-local'){FeDate(el,{'type':'datetime-local'});}}});const UploadHandle=function(el,form,data){var _data;var WH=['width','height'];var options={thumb_wh:78,max_wh:1200,max_size:0,proportion:0,accept:null,images:null,caption:null,reorder:false,};function resize(img,max_wh){let x=0;let y=0;let width=img.width;let height=img.height;if(options.proportion){let proportion=height/width;if(proportion>options.proportion){height=width*options.proportion;y=(img.height-height)/2;}else{width=height/options.proportion;x=(img.width-width)/2;}}
let maj=WH[width>height?0:1];if(x||y||img[maj]>max_wh){let min=WH[maj==WH[0]?1:0];let minWH=width>height?height*max_wh/width:width*max_wh/height;let canvas=JsElement('canvas');let ctx=canvas.getContext('2d');canvas[maj]=max_wh;canvas[min]=Math.round(minWH);ctx.drawImage(img,x,y,width,height,0,0,canvas.width,canvas.height);return canvas.toDataURL(getMimeType(img.src));}
return img.src;}
function getMimeType(src){return src.split(':')[1].split(';')[0];}
function dataURItoBlob(data){data=data.split(',');let mime=getMimeType(data[0]);let bytes=atob(data[1]);let length=bytes.length;let buffer=new ArrayBuffer(length);let uint8=new Uint8Array(buffer);for(let i=0;i<length;i++){uint8[i]=bytes.charCodeAt(i);}
return new Blob([new DataView(buffer)],{type:mime});}
function getAccept(accept){if(!accept){return'*/*';}
if(['audio','image','video'].includes(accept)){return accept+'/*';}
return accept;}
function createElement(el){let container=JsElement('div.input-file'+(isMultiple?' multiple':''));let AddButton=container.appendChild(JsElement('div',{html:'<div class="uh-icon"><i class="fa-solid fa-cloud-arrow-up"></i></div><div>'+options.caption+'</div>','class':'input-field uh-btn',tabindex:0,role:'button',events:{click:function(event){event.stopPropagation();var f=document.body.appendChild(JsElement('input',{type:'file',accept:getAccept(options.accept),multiple:isMultiple,styles:{display:'none',},events:{change:function(){addFiles(f);},},}));f.click();},keydown:function(event){if(event.key=='Enter'){event.preventDefault();event.target.click();}},dragover:function(event){event.preventDefault();},drop:function(event){event.preventDefault();if(event.dataTransfer.files.length){addFiles(event.dataTransfer);}},},toggle:function(status){this.style.display=status?'':'none';if(status){this.focus();}},}));function addFiles(el){if(!isMultiple){AddButton.toggle(false);}
var length=el.files.length;for(var i=0;i<length;i++){(function(file){var frame=newFrame(file.name);var reader=new FileReader();reader.readAsDataURL(file);reader.onprogress=function(response){frame.proggressBar(Math.round(response.loaded/response.total)*100);};reader.onload=function(){frame.proggressBar(-1);if(file.type.match('image.*')){var img=new Image();img.src=this.result;img.onload=function(){let src=resize(this,options.max_wh);frame.removeTitle();frame.addThumb(src);frame.appendData(dataURItoBlob(src),file.name);frame.addCropImage(this.src,dataID);};}else{frame.addFileIcon();frame.appendData(file,file.name);}};})(el.files[i]);}}
var hidden;function reorder(){if(!hidden){hidden=form.appendChild(JsElement('input',{'type':'hidden','name':'__'+_name.substr(0,_name.length-2)}));}
let names=[];Array.from(container.querySelectorAll('div > div[data-name]')).forEach(function(frame){names.push(frame.getAttribute('data-name'));});hidden.value=names.join('|');}
function newFrame(title){let attr={html:'<div>'+(title?'<div class="uh-title">'+title+'</div>':'')+'</div>',tabindex:0,title:title,'aria-label':title,events:{keydown:function(event){event.stopPropagation();if(event.key=='Delete'){remove();}else if(event.key=='Enter'){let el=frame.querySelector('.uh-crop');if(el){el.click();}}}}};if(options.reorder){Object.assign(attr,{draggable:true,events:{dragstart:function(){container.curDrag=this;},dragover:function(event){event.preventDefault();event.dataTransfer.dropEffect='move';return false;},drop:function(event){event.preventDefault();var c=container.curDrag;if(c){switch(c.compareDocumentPosition(this)){case 4:if(this.nextSibling){container.insertBefore(c,this.nextSibling);}else{container.appendChild(c);}
break;case 2:container.insertBefore(c,this);break;}}
reorder();return(container.curDrag=false);}}});}
let frame=container.appendChild(JsElement('div.input-field',attr));let box=frame.querySelector('div');function remove(){if(typeof dataID!='undefined'){_data[--dataID]=false;}
container.removeChild(frame);reorder();AddButton.toggle(true);}
function addThumb(img,name){if(typeof img=='string'){var _img=new Image();_img.src=img;_img.onload=function(){addThumb(this);};if(name){frame.appendChild(JsElement('input',{'type':'hidden','name':name,'value':1}));}}else{let el=box.querySelector('img');if(el){el.parentNode.removeChild(el);}
box.parentNode.classList.add('uh-img');box.appendChild(img);}
return this;}
function addCross(){box.appendChild(JsElement('div.uh-cross',{html:'<i class="fa-solid fa-xmark"></i>',events:{click:function(){remove();}}}));return this;}
return{proggressBar:(function(){var bar;return function(value){if(value==-1){return box.removeChild(bar);}else if(!bar){bar=box.appendChild(JsElement('div.uh-proggress'));}
bar.style.width=value+'%';};})(),removeTitle(){box.removeChild(box.querySelector('.uh-title'));},addThumb:addThumb,addCross:addCross,addCropImage:function(src,dataID){var LastPosition=(function(){var position={};return function(value){if(value){position=value;}
return position;};})();box.appendChild(JsElement('div.uh-crop',{html:'<i class="fa-solid fa-crop-simple"></i>',events:{click:function(){cropImage(src,function(src){var img=new Image();img.src=src;img.onload=function(){let src=resize(this,options.max_wh);_data[dataID-1][1]=dataURItoBlob(src);addThumb(src);frame.focus();};},options,LastPosition);}}}));return this;},appendData:function(src,filename){if(options.max_size&&options.max_size<src.size){box.innerHTML='<div class="uh-icon"><i class="fa-solid fa-triangle-exclamation"></i></div>';}else{dataID=_data.push([_name,src,filename]);}
if(isMultiple){this.setName(filename);}
addCross();},remove:remove,setName:function(v){box.setAttribute('data-name',v);reorder();},addFileIcon:function(){box.innerHTML='<div class="uh-icon"><i class="fa-regular fa-file"></i></div>'+box.innerHTML;}};}
el.parentNode.insertBefore(container,el);el.parentNode.removeChild(el);return{addFrame:function(title){if(!isMultiple){AddButton.toggle(false);}
return newFrame(title);},};};if(!form||form.tagName!='FORM'){for(form=el;form.tagName!='FORM';form=form.parentNode){if(form.tagName=='BODY'){return;}}}
try{Object.assign(options,JSON.parse(el.getAttribute('data-options')));}catch(e){}
_data=data||[];var _name=el.name;var isMultiple='multiple'in JsElement('input')&&el.multiple;if(typeof options.max_wh!='number'){if(options.max_wh.indexOf('x')>-1){let wh=options.max_wh.split('x',2).map(v=>parseInt(v));if(wh[0]>0){options.proportion=wh[1]/wh[0];}
options.max_wh=wh[0]>wh[1]?wh[0]:wh[1];}else{options.max_wh=parseInt(options.max_wh);}}
UH=createElement(el);if(options.images&&options.images[1]){if(isMultiple){options.images[1].forEach(function(v){UH.addFrame().addThumb(options.images[0]+v).addCross().setName(v);});}else{UH.addFrame().addThumb(options.images[0]+options.images[1],_name).addCross();}}
form.addEventListener('reset',function(){var frames=UH.querySelectorAll('.uh-cross');var i=frames.length;while(i--){frames[i].click();}});};JsFelem.implement({file:function(el,form,data){UploadHandle(el,form,data);}});JsFelem.implement({suite:function(el){var name=el.getAttribute('data-name');var box=el.querySelectorAll('li');var All=box[1].querySelectorAll('label');var selected=el.getAttribute('data-selected');var checkAll=el.querySelector('input[type=checkbox]');var Has={};var _count=0;var _total=All.length;function reset(_selected){box[0].querySelectorAll('input').forEach(function(el){Has[el.value](0);});if(typeof _selected!='string'){_selected=selected;}
if(_selected){_selected.split(',').forEach(function(k){if(typeof Has[k]!='undefined'){Has[k](1);}});}}
function dragAndDrop(tag){var corrector,current;JsMove(tag,function(){var target=tag.getBoundingClientRect();var rect=box[0].getBoundingClientRect();corrector={x:target.width/2+rect.left+(window.pageXOffset||document.documentElement.scrollLeft),y:target.height/2+rect.top+(window.pageYOffset||document.documentElement.scrollTop)};},function(event){tag.style.position='absolute';tag.style.left=(event.pageX-corrector.x)+'px';tag.style.top=(event.pageY-corrector.y)+'px';if(current){var target=current.getBoundingClientRect();if(!(target.top<event.clientY&&target.bottom>event.clientY&&target.left<event.clientX&&target.right>event.clientX)){current=null;}}
if(!current){box[0].querySelectorAll('label').forEach(function(x){var target=x.getBoundingClientRect();if(x!=tag&&target.top<event.clientY&&target.bottom>event.clientY&&target.left<event.clientX&&target.right>event.clientX){current=x;}});}},function(){if(current){var target=tag.getBoundingClientRect();var rect=current.getBoundingClientRect();if(rect.left+rect.width/2<target.left+target.width/2){if(current.nextSibling){box[0].insertBefore(tag,current.nextSibling);}else{box[0].appendChild(tag);}}else{box[0].insertBefore(tag,current);}
current=null;}
tag.style.position='';tag.style.left='';tag.style.top='';});}
All.forEach(function(el){var tag;var isSelected=el.classList.contains('selected');var value=el.getAttribute('data-value');var fn=function(show){if(isSelected===show){return;}
if(typeof tag=='undefined'){tag=JsElement('label.input-tag selected',{html:'<input type="hidden" name="'+name+'[]" value="'+value+'"/>'+el.innerHTML});dragAndDrop(tag);}
if(show){box[0].appendChild(tag);el.classList.add('selected');_count++;}else{box[0].removeChild(tag);el.classList.remove('selected');_count--;}
checkAll.checked=(_count==_total);isSelected=show;};el.value=value;el.addEventListener('click',function(){fn(el.classList.contains('selected')?0:1);});Has[value]=fn;});var toggle=function(force){var v=['','none',''];box[0].style.display=v[force];box[1].style.display=v[force+1];btn.forEach(function(el,j){el.style.display=v[force+(j==3?0:1)];});};checkAll.addEventListener('change',function(){var force=checkAll.checked==true?1:0;All.forEach(function(el){Has[el.value](force);});});var btn=el.querySelectorAll('div');btn[0].addEventListener('click',function(){toggle(0)});btn[1].addEventListener('click',reset);btn[3].addEventListener('click',function(){toggle(1)});toggle(1);reset(selected);el.value=selected;el.type='suite';el.reset=reset;}});function Backlist(ID){function Rows(_controls){let rows=[];let that={getButtons:function(){return _buttons;},getCheckAll:function(){return _checkall;},add:function(row){let checkbox=row.querySelector('input[type=checkbox]');if(!checkbox||checkbox.disabled){return;}
let data=row.getAttribute('row-labels');let labels=data?data.split(','):[];function toggle(state){checkbox.checked=state;row.classList.toggle('active',state);_buttons.refresh();refresh();}
checkbox.addEventListener('change',function(event){event.stopPropagation();toggle(!checkbox.checked);});row.addEventListener('click',function(){toggle(!checkbox.checked);});rows.push({checkbox,row,toggle,hasLabel:function(label){return labels.indexOf(label)!=-1;}});},restart:function(){rows=[];},numSelected:function(){let count=0;let i=rows.length;while(i--&&count<2){if(rows[i].checkbox.checked){count++;}}
return count;},hasLabel:function(label){let i=rows.length;while(i--){if(rows[i].checkbox.checked&&!rows[i].hasLabel(label)){return false;}}
return true;},hasLabelFrom:function(btn,label){let row=getRowFromButton(btn);let i=rows.length;while(i--){if(rows[i].row==row){return rows[i].hasLabel(label);}}
return true;},select:function(btn){let i=rows.length;let row=getRowFromButton(btn);while(i--){rows[i].toggle(rows[i].row==row);}}};let _buttons=Buttons(that);let _checkall=CheckAll(function(status){let i=rows.length;while(i--){rows[i].toggle(status);}
_buttons.refresh();});function refresh(){let i=rows.length;while(i--){if(!rows[i].checkbox.checked){return _checkall.checked(false);}}
return _checkall.checked(true);}
function getRowFromButton(btn){let row=btn;for(;row.getAttribute('control-row')==undefined;row=row.parentNode){if(row.tagName=='BODY'){return null;}}
return row;}
_controls.attachAll('row',{default:function(el){that.add(el);},'check-all':function(el){_checkall.add(el);},});return that;}
function Buttons(_row){let buttons=[];let rules={};let labels={};let values=[{'0':true,'1':false,'+':false,'?':true},{'0':false,'1':true,'+':true,'?':true},{'0':false,'1':false,'+':true,'?':false}];function getButton(target){return buttons.find((button)=>button.target==target);}
let that={add:function(name,target){if(['0','1','+','?'].indexOf(rules[name])!==-1){buttons.push({target:target,status:function(total){let status=values[total][rules[name]];if(status&&labels[name]){return _row.hasLabel(labels[name]);}
return status;},virtuallyStatus:function(){let status=values['1'][rules[name]];if(status&&labels[name]){return _row.hasLabelFrom(target,labels[name]);}
return status;}});}},addCmd:function(name,numRows,onlyRows){rules[name]=String(numRows);if(typeof onlyRows!=='undefined'){if(onlyRows===true){onlyRows=name;}
labels[name]=String(onlyRows);}},refresh:function(){let total=_row.numSelected();buttons.forEach(function(button){let disabled=!button.status(total);button.target.classList.toggle('disabled',disabled);button.target.setAttribute('aria-disabled',disabled);});},clean:function(){buttons=buttons.filter(function(button){return document.body.contains(button.target);});},isDisabled:function(el){return el.classList.contains('disabled')||el.getAttribute('aria-disabled')==='true';},isVirtuallyDisabled:function(el){let button=getButton(el);return button?!button.virtuallyStatus():false;}};return that;}
function CheckAll(callback){let elements=[];let that={toggle:function(force){callback(force);},check:function(){this.toggle(true);},uncheck:function(){this.toggle(false);},checked:function(force){elements.forEach(function(el){el.toggle(force);});},add:function(el){let cmd=el.getAttribute('data-checkall');if(!['uncheck','check'].includes(cmd)){cmd='toggle';}
if(el.tagName=='INPUT'){el.addEventListener('change',function(event){event.stopPropagation();that[cmd](el.checked);});el.toggle=function(force){el.checked=force;}}else{el.addEventListener('click',function(){that[cmd](el.getAttribute('data-toggle'));});el.toggle=function(force){el.setAttribute('data-toggle',force);}}
elements.push(el);},};return that;}
function Filters(_controls,callback){let $box,$filters,$form;function Sticky(el){if(typeof el=='string'){el=document.querySelector(el);}
let v=0;let H=document.querySelector('header[data-sticky]');function fn(){let top=H?H.getBoundingClientRect().height:0;if(v!=(document.documentElement.scrollTop>top)){v=el.classList.toggle('active');el.style.top=top+'px';TooltipActive.hide();}}
fn();window.addEventListener('scroll',fn);}
let that={toggle:function(){let value=$filters.style.display==''?'none':'';$filters.style.display=value;JsCookie.set('ListFilters',value);},reset:function(){callback();},setBox:function(el){el=el.querySelector('[backlist-actions]');$box=el.firstChild.nextSibling;Sticky(el);},load:function(el){$filters=el.querySelector('[backlist-filters]');if(!$filters){return;}
_controls.load('filter',el,function(el,fn){el.addEventListener('click',function(event){event.stopPropagation();fn(el,$form);});});if($box){$box.innerHTML='';$box.appendChild($filters);}
$filters.style.display=JsCookie.get('ListFilters');$form=$filters.querySelector('form');$form.addEventListener('submit',function(event){callback(event,$form)});JsFelem.load($form);}};_controls.attachAll('filter',{sort:function(el){let value=el.getAttribute('data-value');if($form.order.value==value){$form.sort.value=$form.sort.value=='desc'?'asc':'desc';}
$form.order.value=value;JsFelem.submit($form);},search:function(el){$form.search.value=el.getAttribute('data-value');let field=el.getAttribute('data-field');if(field&&typeof $form.field=='object'){$form.field.value=field;}
JsFelem.submit($form);},change:function(el){let name=el.getAttribute('data-name');let value=el.getAttribute('data-value');if($form[name].type=='checkbox'){$form[name].checked=value;}else{$form[name].value=value;}
JsFelem.submit($form);},});_controls.attachAll('list',{filters:function(){that.toggle();},'filters-reset':function(){that.reset();}});return that;}
function List($box,callback){let onSuccess;let _options={};let _page=1;let _filtersData={};let _data=null;let requiresData=false;function combine(a,b){for(let i in b){a[i]=(typeof a[i]=='object')?combine(a[i],b[i]):b[i];}
return a;}
return{setPage:function(page){_page=page;},setFilters:function(data){_filtersData=data;},setData:function(data){_data??={};if(data===undefined){requiresData=true;}else{_data=combine(_data,data);}},init:function(options,$U){if(requiresData){let $form=this.getForm();if($form){Array.from($form.elements).forEach(function(el){if(el.type=='hidden'&&el.name&&!el.disabled){_data[el.name]=el.value;}});}}
switch(typeof options){case'string':_options.url=options;break;case'object':_options=options;break;}
if(!_options.url&&$U){_options.url=$U('list');}
_options.format='text';onSuccess=typeof _options.onSuccess=='function'?_options.onSuccess:false;_options.onSuccess=function(html){$box.innerHTML=html;callback();};},request:function(){_options.data=[];if(_data!==null){_options.data.push(_data);}
if(_page>1){_options.data.push({page:_page});}
if(_filtersData){_options.data.push(_filtersData);}
$box.focus();JsRequest.load(_options);},getForm:function(name){$form=$box?$box.querySelector('[backlist-form]'):null;if(name){return typeof $form[name]!='undefined'?$form[name].value:undefined;}
return $form;},getHash:function(){return _page+(_filtersData?'/'+_filtersData:'');},fireSuccess:function(){if(onSuccess){onSuccess($box);}},};}
function Hash(_list,callback){function hash(){return window.self.document.location.hash;}
let handler,current='';let that={load:function(){if(!handler){current=hash();handler=setInterval(function(){if(current!=hash()){current=hash();that.load();callback();}},300);}
let part=current.substring(1).split('/');let page=parseInt(part.shift())||1;let filters=part.join('/');_list.setPage(page);_list.setFilters(filters);},save:function(){if(handler){window.self.document.location.hash=_list.getHash();current=hash();}
return this;},};return that;}
function Options($box,_controls,_buttons){let $form;return{load:function(){let $options=$box.querySelector('div[backlist-actions]');if(!$options){return;}
_controls.load('list',$options,function(el,fn,cmd){_buttons.add(cmd,el);function fn2(event){event.preventDefault();if(_buttons.isDisabled(el)){return;}
JsDropdown.hide();fn(el);}
if(cmd=='create'){$form=el.parentNode;if($form.tagName=='FORM'){$form.addEventListener('submit',fn2);}else{$form=false;}}
el.addEventListener('click',fn2);});JsFelem.load($options);},getData:function(data){if($form){data.push($form);}}};}
function _pagination(el,callback){let bts=Array.from(el.querySelectorAll('.footer *[control-page]'));bts.forEach(function(bt){bt.addEventListener('click',function(event){let page=parseInt(bt.getAttribute('control-page'));callback(event,page);});});}
function toQueryString($form){let data=[];Array.from($form.elements).forEach(function(el){if(el.name&&!el.disabled){if(el.type=='select-multiple'){for(let i=0;i<el.options.length;i++){if(el.options[i].selected){data.push(el.name+'='+el.options[i].value);}}}else if(['checkbox','radio'].indexOf(el.type)==-1||el.checked){data.push(el.name+'='+el.value);}}});return data.join('&');}
function objToFn(options,cmd){if(typeof options.modalOptions=='object'){options.load='modal';}else if(typeof options.load=='undefined'){options.load='xjs';}
if(!options.url&&$U){options.url=$U(cmd);}
let isEditable=(typeof options.editable!='undefined'&&options.editable);let fn=function(el){if(typeof options.onSubmit=='function'&&!options.onSubmit(el)){return;}
if(isEditable&&el.style.display!='none'){el.style.display='none';let value=el.innerHTML;let input=el.parentNode.appendChild(JsElement('input.input-field',{name:cmd,value:value,events:{click:function(event){event.stopPropagation();},keydown:function(event){if(event.key=='Enter'){event.preventDefault();input.blur();}},blur:function(){if(this.value==value){el.style.display='';input.parentNode.removeChild(input);}else{fn(el);}}},}));input.focus();return false;}
let _options=Object.assign({},options);let data=[];let $form=_list.getForm();if($form){data.push($form);}
if(cmd=='create'&&!options.numRows){_listOptions.getData(data);}
let value=el.getAttribute('data-value');if(value){data.push({[el.getAttribute('data-name')||cmd]:value});}
switch(typeof options.data){case'function':case'string':case'object':data.push(options.data);break;}
_options.data=data;JsRequest.load(_options);};return fn;}
let $U,_initialized;let $box=document.getElementById((ID?ID+'-':'')+'backlist-box');let $list=$box?.querySelector('div[backlist-slot]');if($box){JsNotify.creator($box);}
let _controls=JsControls({list:{refresh:function(){that.refresh();},view:function(el){JsDropdown(el.nextSibling).toggle();},'tg-body':function(el){el.parentNode.classList.toggle('expand');},}});let _rows=Rows(_controls);let _buttons=_rows.getButtons();let _filters=Filters(_controls,function(event,data){if(event){event.preventDefault();}
_list.setPage(1);_list.setFilters(data?toQueryString(data):'');_hash.save();that.load();});let _list=List($list,function(){that.async()});let _hash=Hash(_list,function(){that.load()});let _listOptions=Options($box,_controls,_buttons);let that={url:function(fn){if(typeof fn=='function'){$U=fn;}
return this;},data:function(data){_list.setData(data);return this;},allowHistory:function(){_hash.load();return this;},controls:function(controls,handler){if(!handler){handler='list';}
for(let cmd in controls){(function(options){switch(typeof options){case'object':if(handler!='list'){break;}
if(typeof options.numRows=='undefined'){options.numRows=(cmd=='create')?0:'+';}
_buttons.addCmd(cmd,options.numRows,options.onlyRows);if(typeof options.fn=='function'){options=options.fn;}else{options=objToFn(options,cmd);}
case'function':_controls.attach(handler,cmd,options);}})(controls[cmd]);}
return this;},setControlsWithTarget(controls,target){if(target){for(let cmd in controls){if(typeof controls[cmd]==='object'&&typeof controls[cmd].modalOptions==='object'){controls[cmd].modalOptions.target=target;}}}
return this.controls(controls);},load:function(options){if(!$box){return;}
let _request=true;if(!_initialized){_initialized=true;_request=!$list.innerHTML;_filters.setBox($box);_list.init(options,$U);_listOptions.load();Tooltip($box);}
_rows.restart();if(_request){_list.request();}else{this.async();}
return this;},async:function(){let $form=_list.getForm();if($form){_buttons.clean();_controls.load('list',$form,function(el,fn,cmd){_buttons.add(cmd,el);el.addEventListener('click',function(event){event.stopPropagation();if(_buttons.isVirtuallyDisabled(el)){return;}
_rows.select(el);fn(el);});});_controls.load('row',$form);_buttons.refresh();_pagination($list,function(event,page){_list.setPage(page);_hash.save();that.load();});_filters.load($list);_list.fireSuccess();Tooltip($list);}
return this;},refresh:function(){this.load();},getElement:function(selector){if(selector){return $box.querySelector(selector);}
return $box;},getForm:function(name){return _list.getForm(name);},getFormValue:function(name){if(!name){return null;}
return _list.getForm(name);},getFiltersData:function(){let h=location.hash.split('/')[1];let data={};if(h){h.split('&').forEach(function(row){row=row.split('=');data[row[0]]=row[1];});}
return data;},notify:function(options){$box.notify(options);},};return that;};function FormBox(box){if(!box){box=0;}
switch(typeof box){default:box='';case'number':box='#form-box'+(box||'');case'string':box=document.querySelector(box)||document.querySelector('#'+box+'-box');case'object':if(!box){return;}}
let _controls=JsControls({form:{'nav-prev':function(){that.select(selected-1);},'nav-next':function(){that.select(selected+1);},'refresh':function(){that.refresh();},},});let tabs=box.firstChild;if(tabs.classList.contains('tablist')){tabs=JsTabs(tabs);}else{tabs=false;}
let tabOptions=[];let isloaded=false;let selected=0;let panel=box;function _update(el,options,force){if(!options){return;}
function _onLoad(){_controls.load('form',el,function(el,fn){el.addEventListener('click',function(){fn();});});if(typeof options.onLoad=='function'){options.onLoad();}}
if(!force&&el.firstChild){if(!isloaded){isloaded=true;_onLoad();}}else{options.onSuccess=function(html){el.innerHTML=html;_onLoad();};JsRequest.text(options);}}
let that={controls:function(options){for(let i in options){if(typeof options[i]=='function'){_controls.attach('form',i,options[i]);}}
return this;},tab:function(options){tabOptions.push(options);return this;},select:function(i,force){if(tabs){tabs.select(i);panel=tabs.getContainer();selected=tabs.selectedTabNumber();}
_update(panel,tabOptions[selected],force);return this;},refresh:function(){this.select(selected,true);},};JsNotify.creator(that,box);return that;}
const FormRow=function(el){if(typeof el==='string'){el=document.querySelector(el);}
if(typeof el!=='object'){return null;}
function isRow(el){return el.classList.contains('form-group');}
function getRow(el){while(el.tagName!=='BODY'){if(isRow(el)){return el;}
el=el.parentNode;}}
function getSibling(el,jump){const total=Math.abs(jump);const forward=jump>0;for(let i=0;i<total;i++){if(forward){el=el.nextElementSibling;}else{el=el.previousElementSibling;}
if(!el){return null;}}
return FormRow(el);}
const $row=getRow(el);if(typeof $row!=='object'){return null;}
let that={prev:function(jump=1){return getSibling($row,-jump);},next:function(jump=1){return getSibling($row,jump);},toggle:function(status){$row.style.display=status?'':'none';return that;},clone:function(callback){let $new=$row.cloneNode(true);if(typeof callback==='function'){$new=callback($new);}
return FormRow($new);},getElement:function(selector){if(selector){return $row.querySelector(selector);}
return $row;},insertBefore:function($new){$row.parentNode.insertBefore($new.getElement(),$row);return $new;},insertAfter:function($new){const el=$row.nextElementSibling;if(el){el.parentNode.insertBefore($new.getElement(),el);}else{$row.parentNode.appendChild($new.getElement());}
return $new;},remove:function(){$row.parentNode.removeChild($row);}};return that;}
const FormFieldset=function(el){if(typeof el==='string'){el=document.querySelector(el);}
if(typeof el!=='object'){return null;}
function getRow(el){while(el.tagName!=='BODY'){if(el.classList.contains('form-fieldset')){return el;}
el=el.parentNode;}}
const $fieldset=getRow(el);if(typeof $fieldset!=='object'){return null;}
let that={getRow:function(number=0){const rows=$fieldset.querySelectorAll('.form-body .form-group');if(rows.length>number){return FormRow(rows[number]);}
return null;},getElement:function(selector){if(selector){return $fieldset.querySelector(selector);}
return $fieldset;},remove:function(){$fieldset.parentNode.removeChild($fieldset);}};return that;}
JsFelem.implement({userpicker:function(el){JsCollection(el,{url:JsUrl('admin/users/users'),});}});